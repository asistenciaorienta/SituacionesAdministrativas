<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Formulario Unificado</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <!-- Dise√±o e idea original de la Direcci√≥n Provincial de Granada, en concreto de:
    Jefe de Servicio: Francisco Escabias Garc√≠a.
    Dise√±ador: Valent√≠n Jim√©nez Extremera.
    Contenido: Elisabeth Huertas Garc√≠a y Jos√© Manuel Robles Chaves.
    Testeo y verificaci√≥n: Isabel Pel√°ez Carmona, Silvia G√≥mez Mart√≠n, Inmaculada Ortega Avil√©s, Beatriz Girela Mu√±oz.
    Aporte de informaci√≥n: Todas las oficinas SAE de la provincia de Granada y sus direcciones de ATE. -->

    <div id="titulo" class="nacionalidad-card">
      <h1>Ayuda para el registro en SILA de una persona migrante</h2>
    </div>
    <div id="inicio" class="nacionalidad-card">
      <button class="btn-small" onclick="volverInicio(); confirmarBorrado();">Inicio</button>
    </div>
      <div id="ayuda" class="nacionalidad-card">
      <button class="btn-small" onclick="ayuda();">Ayuda</button>
    </div>  
          
    <!-- P√°gina de nacionalidad (ORIGEN) -->
    <div id="nacionalidad-page" class="nacionalidad-card">


      <h2>Selecciona el Origen de la persona usuaria</h2>

      <div class="botones-nacionalidad">
        <div class="btn-wrapper">
          <button class="btn" onclick="mostrarFormularioComunitario()">Comunitario/a</button>
          <span class="tooltip-container">
            <span class="help-icon">?</span>
            <div class="tooltip-text">
              <strong>Pa√≠ses comunitarios:</strong><br>
                Austria, B√©lgica, Bulgaria, Chipre, Rep√∫blica Checa, Dinamarca, Estonia, Finlandia, Francia,
                Alemania, Grecia, Hungr√≠a, Irlanda, Italia, Letonia, Lituania, Luxemburgo, Malta,
                Pa√≠ses Bajos, Polonia, Portugal, Ruman√≠a, Eslovaquia, Eslovenia, Espa√±a, Suecia,
                Islandia, Liechtenstein, Noruega, Suiza.
            </div>
          </span>
        </div>
        <button class="btn" onclick="mostrarFormularioNoComunitario()">No Comunitario/a</button>
      </div>
      
    </div>
  
    <!-- Documentaci√≥n Necesaria para Comunitario -->
    <div id="Doc_Necesaria_Comunitario" class="hidden">
      <h2>Documentaci√≥n Necesaria para Inscribir a una persona Comunitaria</h2>
      <br>
      Documento acreditativo de identidad
      <br>
      Certificado de inscripci√≥n .....
      <br>
      Tarjeta Verde...
      <br>
      <br>
      <button class="btn-small" onclick="volverNacionalidad()">‚Üê Volver</button>
    </div>

    <!-- Formulario No Comunitario -->
    <div id="formulario_No_Comunitario" class="hidden">
      <h2>¬øQue documentaci√≥n aporta la persona No Comunitaria?</h2>
      <div class="document-list">
        <label class="document-item">
          <input type="radio" name="documento" value="TIE" onclick="gestionarSeleccion(this)">
          TIE
        </label>
        <div id="subopciones-TIE" class="sub-options">
          <label><input type="radio" name="estado-TIE" value="En Vigor"> En Vigor</label>
          <label><input type="radio" name="estado-TIE" value="Caducad"> Caducada</label>
        </div>

        <label class="document-item">
          <input type="radio" name="documento" value="Resoluci√≥n" onclick="gestionarSeleccion(this)">
          Resoluci√≥n
        </label>
        <div id="subopciones-Resoluci√≥n" class="sub-options">
          <label><input type="radio" name="estado-Resoluci√≥n" value="En Vigor"> En Vigor</label>
          <label><input type="radio" name="estado-Resoluci√≥n" value="Caducado"> Caducada</label>
        </div>

        <label class="document-item">
          <input type="radio" name="documento" value="Tarjeta Roja" onclick="gestionarSeleccion(this)">
          Tarjeta Roja
        </label>
        <div id="subopciones-Tarjeta Roja" class="sub-options">
          <label><input type="radio" name="estado-Tarjeta" value="En Vigor"> En Vigor</label>
          <label><input type="radio" name="estado-Tarjeta" value="Caducado"> Caducada</label>
        </div>

        <label class="document-item">
          <input type="radio" name="documento" value="NIE" onclick="gestionarSeleccion(this)">
          NIE
        </label>
        <div id="subopciones-NIE" class="sub-options">
          <label><input type="radio" name="estado-NIE" value="Aporta Solicitud"> Aporta Solicitud</label>
          <label><input type="radio" name="estado-NIE" value="No aporta"> No aporta Solicitud</label>
        </div>
      </div>
      <button class="btn" onclick="evaluarDocumento()">Continuar</button>   <br>   
      <button class="btn-small" onclick="volverNacionalidad()">‚Üê Volver</button>
    </div>

    <!-- Imagen del manual -->
    <div id="manual" class="hidden">
      <h2>Consulta el manual</h2>
      <img id="manualImg" src="" alt="Manual">
      <br>
      <button class="btn" onclick="mostrarFormulario()">Continuar</button> <br>
      <button class="btn-small" onclick="volverNoComunitario()">‚Üê Volver</button>
    </div>

    <!-- Mensaje aclaratorio -->
    <div id="mensaje-aclaratorio" class="hidden">
      <h2>Aclaraci√≥n</h2>
      <p id="contenido-aclaratorio">Aqu√≠ aparecer√° el contenido seg√∫n la selecci√≥n.</p>
      <button class="btn-small" onclick="volverNoComunitario()">‚Üê Volver</button>
    </div>

    <!-- Formulario completo -->
    <div id="formulario" class="hidden">
      <div class="card">
        <!-- Campo de b√∫squeda -->
        <div class="search-container">
          <textarea id="search-box" placeholder="Copia aqu√≠ los conceptos clave..." rows="4" onfocus="preguntarBorrado(event)"></textarea> 
        </div>

        <!-- Bot√≥n de buscar -->
        <div class="button-container">
          <button id="buscarBtn" onclick="ocultar_resultado();">Buscar</button>
        </div>
        <div id="loader" style="display:none; text-align:center; margin:10px;">
          <span>üîÑ Buscando... por favor, espera</span>
        </div>

        <div id="resultado" class="hidden"></div>

        <div id="sugerenciasPanel" class="panel-sugerencias hidden">
          <h3 style="text-align:center;">Selecciona uno o m√°s conceptos clave:</h3>
          <form id="sugerenciasForm" class="sugerencias-grid"></form>
          <div style="text-align: center;">
            <button class="btn" onclick="buscarDesdeSugerencias()">Buscar con selecci√≥n</button>
            <button class="btn-small" onclick="ocultarSugerencias()">‚Üê Ocultar</button>
          </div>
        </div>

        <!-- Bot√≥n de volver -->
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn-small" onclick="volverInicioDesdeFormulario(); confirmarBorrado();">‚Üê Volver</button>
        </div>
      </div>
    </div>

    <!-- Modal personalizado ALERTA-->
    <div id="mi-modal" class="hidden modal">
      <div class="modal-content">
        <p id="modal-texto"></p>
        <button class="btn" onclick="cerrarModal()">Cerrar</button>
      </div>
    </div>

    <!-- Modal para confirmar borrado -->
    <div id="modal-borrar" class="hidden modal">
      <div class="modal-content">
        <p>¬øDeseas borrar el contenido actual?</p>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn" onclick="confirmarBorrado()">S√≠, borrar</button>
          <button class="btn-small" onclick="cerrarModalBorrar()">No, modificar</button>
        </div>
      </div>
    </div>

    <!-- Pie de p√°gina fijo -->
    <footer>
      <div class="footer-logo">
        <div class="logo-text">Direcci√≥n Provincial de Granada</div>
        <img src="https://i.imgur.com/sX386es.png" alt="Logo Junta de Andaluc√≠a" />
      </div>
      <div class="footer-datos">
        <b>Apoyo durante la fase de testeo para la resoluci√≥n de dudas y la recogida de incidencias:</b><br>
        <hr>
        Elisabeth Huertas Garc√≠a &lt;<a href="mailto:elisabeth.huertas.garcia@juntadeandalucia.es">elisabeth.huertas.garcia@juntadeandalucia.es</a>&gt; ‚Äì 765145<br>
        Jos√© Manuel Robles Chaves &lt;<a href="mailto:josem.robles@juntadeandalucia.es">josem.robles@juntadeandalucia.es</a>&gt; ‚Äì 653467
      </div>
    </footer>
    
    <script>
      function ayuda() {
        window.open("https://www.tupagina.com", "_blank");
      }
      
      function actualizarDisponibles() {
        const checkboxes = Array.from(document.querySelectorAll('#sugerenciasForm input[type="checkbox"]'));
        const labels = Array.from(document.querySelectorAll('#sugerenciasForm label'));

        // Seleccionados actualmente (checkbox checked)
        const seleccionados = checkboxes.filter(cb => cb.checked).map(cb => cb.value);

        // Si no hay seleccionados, activar todo y quitar clase disabled
        if (seleccionados.length === 0) {
          checkboxes.forEach(cb => {
            cb.disabled = false;
          });
          labels.forEach(label => {
            label.classList.remove('disabled');
          });
          return;
        }

        // Funci√≥n para comprobar si una combinaci√≥n v√°lida contiene TODOS los seleccionados + candidato
        // Queremos que al marcar otro, la combinaci√≥n sea una superconjunto de los seleccionados actuales + ese candidato
        function esCompatible(candidato) {
          // Por cada combinaci√≥n v√°lida
          return combinacionesValidas.some(comb => {
            // La combinaci√≥n debe contener al candidato
            if (!comb.includes(candidato)) return false;

            // Y debe contener todos los seleccionados
            return seleccionados.every(sel => comb.includes(sel));
          });
        }

        // Recorremos todos checkboxes y deshabilitamos si no es compatible
        checkboxes.forEach(cb => {
          if (seleccionados.includes(cb.value)) {
            // Checkbox seleccionado: siempre habilitado
            cb.disabled = false;
            cb.parentElement.classList.remove('disabled');
          } else {
            // No seleccionado: habilitar solo si es compatible con la selecci√≥n
            if (esCompatible(cb.value)) {
              cb.disabled = false;
              cb.parentElement.classList.remove('disabled');
            } else {
              cb.disabled = true;
              cb.parentElement.classList.add('disabled');
            }
          }
        });
      }

      // A√±adir evento a cada checkbox para actualizar al cambiar
      function anadirEventosCheck() {
        const checkboxes = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.addEventListener('change', actualizarDisponibles);
        });
      }

      // En tu funci√≥n mostrarSugerencias, tras crear el formulario, llama a a√±adirEventosCheck()


      function ocultar_resultado(){
        document.getElementById('resultado').classList.add('hidden');
      }
      
      function preguntarBorrado() {
        const textarea = document.getElementById('search-box');

        // Si el modal ya est√° abierto, no hacer nada
        const modalVisible = !document.getElementById('modal-borrar').classList.contains('hidden');
        if (modalVisible) return;

        // Si hay texto, mostrar el modal
        if (textarea.value.trim() !== '') {
          textarea.blur(); // Para evitar escribir mientras responde
          document.getElementById('modal-borrar').classList.remove('hidden');
        }
      }
      function confirmarBorrado() {
        const textarea = document.getElementById('search-box');
        textarea.value = '';
        cerrarModalBorrar();
      }

      function cerrarModalBorrar() {
        document.getElementById('search-box').focus();
        document.getElementById('modal-borrar').classList.add('hidden');
        document.getElementById('resultado').classList.add('hidden');
      }

      const urls = {
        "TIE": "https://i.imgur.com/6YW6bTX.png",
        "Documento": "https://i.imgur.com/mws3JN2.png",
        "Tarjeta Roja": "https://i.imgur.com/qjRKecb.png"
      };

      const conceptosClave = [
        "Art 50 TUE. Retirada Reino Unido",
        "Asilo / Ap√°trida / Desplazados o protecci√≥n internacional",
        "Circunstancias excepcionales",
        "Estudio, pr√°cticas o voluntariado",
        "Familiar de ciudadano de UE",
        "Ley 14/2013",
        "Menores",
        "Reagrupaci√≥n familiar",
        "Residencia temporal que Autoriza a trabajar",
        "Residencia temporal que No Autoriza a trabajar",
        "Residencia Larga Duraci√≥n",
        "Permiso de Residencia y Trabajo",
        "Visado b√∫squeda empleo",
        "Prestaci√≥n sin autorizaci√≥n laboral"
      ];

      const combinacionesValidas = [
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia temporal que Autoriza a trabajar"],
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia temporal que No Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que No Autoriza a trabajar"],        
        ["Residencia Larga Duraci√≥n", "Permiso de Residencia y Trabajo"],
        ["Asilo / Ap√°trida / Desplazados o protecci√≥n internacional", "Residencia Larga Duraci√≥n", "Permiso de Residencia y Trabajo"]
      ];

      function gestionarSeleccion(seleccionado) {
        const opciones = ["TIE", "Resoluci√≥n", "Tarjeta Roja", "NIE"];
        
        // Ocultar todas las subopciones y limpiar selecciones previas
        opciones.forEach(opcion => {
          const subDiv = document.getElementById(`subopciones-${opcion}`);
          if (subDiv) {
            subDiv.style.display = "none";
            const radios = subDiv.querySelectorAll('input[type="radio"]');
            radios.forEach(r => r.checked = false);
          }
        });

        // Mostrar solo las subopciones correspondientes
        const seleccion = seleccionado.value;
        const sub = document.getElementById(`subopciones-${seleccion}`);
        if (sub) sub.style.display = "flex";
      }

      function evaluarDocumento() {
        const seleccionPrincipal = document.querySelector('input[name="documento"]:checked');
        if (!seleccionPrincipal) {
          mostrarModal("Selecciona una opci√≥n.");
          return;
        }

        const valorPrincipal = seleccionPrincipal.value;
        let subValor = null;

        // Detectar subvalor seg√∫n el documento principal
        if (valorPrincipal === "TIE") {
          subValor = document.querySelector('input[name="estado-TIE"]:checked')?.value;
        } else if (valorPrincipal === "Resoluci√≥n") {
          subValor = document.querySelector('input[name="estado-Resoluci√≥n"]:checked')?.value;
        } else if (valorPrincipal === "Tarjeta Roja") {
          subValor = document.querySelector('input[name="estado-Tarjeta"]:checked')?.value;
        } else if (valorPrincipal === "NIE") {
          subValor = document.querySelector('input[name="estado-NIE"]:checked')?.value;
        }

        if (!subValor) {
          mostrarModal("Selecciona una sub-opci√≥n.");
          return;
        }

        // Mostrar manual si est√° en vigor
        if (valorPrincipal === "TIE" && subValor === "En Vigor") {
          mostrarManual("TIE");
        } else if (valorPrincipal === "Resoluci√≥n" && subValor === "En Vigor") {
          mostrarManual("Documento");
        } else if (valorPrincipal === "Tarjeta Roja" && subValor === "En Vigor") {
          mostrarManual("Tarjeta Roja");
        } else {
          // Mostrar aclaraci√≥n
          document.getElementById("formulario_No_Comunitario").classList.add("hidden");
          document.getElementById("mensaje-aclaratorio").classList.remove("hidden");
          document.getElementById("contenido-aclaratorio").textContent = `Has seleccionado: ${valorPrincipal} - ${subValor}. Aqu√≠ aparecer√° la aclaraci√≥n correspondiente.`;
        }
      }

      function mostrarModal(mensaje) {
        document.getElementById("modal-texto").textContent = mensaje;
        document.getElementById("mi-modal").classList.remove("hidden");
      }

      function cerrarModal() {
        document.getElementById("mi-modal").classList.add("hidden");
      }

      function mostrarFormularioComunitario() {
        document.getElementById("nacionalidad-page").classList.add("hidden");
        document.getElementById("Doc_Necesaria_Comunitario").classList.remove("hidden");
        document.getElementById("titulo").classList.add("hidden");
      }      

      function mostrarFormularioNoComunitario() {
        document.getElementById("nacionalidad-page").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.remove("hidden");
        document.getElementById("titulo").classList.add("hidden");
      }

      function mostrarManual(tipo) {
        localStorage.setItem("tipoDocumento", tipo);        
        document.getElementById("formulario_No_Comunitario").classList.add("hidden"); 
        document.getElementById("manualImg").src = urls[tipo];
        document.getElementById("manual").classList.remove("hidden");       
      }

      function mostrarFormulario() {
        document.getElementById("manual").classList.add("hidden");
        document.getElementById("formulario").classList.remove("hidden");
      }

      function volverNacionalidad() {
        document.getElementById("Doc_Necesaria_Comunitario").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.add("hidden");
        document.getElementById("nacionalidad-page").classList.remove("hidden");
        document.getElementById("titulo").classList.remove("hidden");
      }
      
      function volverNoComunitario() {
        document.getElementById("manual").classList.add("hidden");  
        document.getElementById("mensaje-aclaratorio").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.remove("hidden");
      }

      function mostrarResultado(data) {
          const contenedor = document.getElementById("resultado");
          contenedor.innerHTML = ""; // Limpiar resultados anteriores

          if (!data || data.length === 0) {
            const ayuda = document.createElement("p");
            ayuda.innerHTML = `
              <p style="text-align: center;">No se encontr√≥ nada. Si necesitas ayuda, puedes clicar en: 
              <button class="btn-small" onclick="mostrarSugerencias()">Mostrar sugerencias</button></p>
            `;
            contenedor.appendChild(ayuda);
            return;
          }

          data.forEach(item => {
            const card = document.createElement("div");
            card.className = "resultado-item";
            card.innerHTML = `
              <p><strong>C√≥digo:</strong> ${item.codigo}</p>
              <p><strong>Autorizaci√≥n:</strong> ${item.autoriza}</p>
              <p><strong>Modalidad:</strong> ${item.modalidad}</p>
              <p><strong>Observaciones:</strong> ${item.observaciones}</p>
              <p><strong>Documentaci√≥n:</strong> ${item.documento}</p>
              <hr>
            `;
            contenedor.appendChild(card);
          });
      }

      function mostrarSugerencias() {
        const panel = document.getElementById("sugerenciasPanel");
        const form = document.getElementById("sugerenciasForm");

        // Mostrar el panel con animaci√≥n (quita clase hidden y a√±ade visible con delay)
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("visible"), 100);

        // Dividir conceptos en dos columnas de 7 elementos
        const primeraColumna = conceptosClave.slice(0, 7);
        const segundaColumna = conceptosClave.slice(7, 14);

        // Crear contenido HTML para ambas columnas dentro del formulario
        const col1HTML = primeraColumna.map(c =>
          `<label><input type="checkbox" name="concepto" value="${c}"> ${c}</label>`
        ).join("");

        const col2HTML = segundaColumna.map(c =>
          `<label><input type="checkbox" name="concepto" value="${c}"> ${c}</label>`
        ).join("");

        // Insertar el contenido en el formulario (sugerenciasForm)
        form.innerHTML = `
          <div class="columna-izq">${col1HTML}</div>
          <div class="columna-der">${col2HTML}</div>
        `;
        anadirEventosCheck();
        actualizarDisponibles();  
      }

      function ocultarSugerencias() {
        const panel = document.getElementById("sugerenciasPanel");
        panel.classList.remove("visible");
        setTimeout(() => panel.classList.add("hidden"), 600);
      }

      function mostrarAyudaConceptos() {
        const container = document.getElementById("resultado");
        const lista = conceptosClave.map(c => `<li>${c}</li>`).join("");
        container.innerHTML = `
          <h3 style="color: #007A33;">Conceptos que puedes utilizar:</h3>
          <ul style="text-align: left; max-width: 700px; margin: 20px auto; font-size: 16px; line-height: 1.6;">
            ${lista}
          </ul>
          <div style="text-align: center; margin-top: 20px;">
            <button class="btn-small" onclick="document.getElementById('resultado').classList.add('hidden');">‚Üê Ocultar ayuda</button>
          </div>`;
      }

      function volverInicioDesdeFormulario() {
        document.getElementById("search-box").value = "";

        document.getElementById("formulario").classList.add("hidden");
        document.getElementById("manual").classList.remove("hidden");
        document.getElementById("buscarBtn").classList.remove("hidden");
      }

      function volverInicio() {
        document.getElementById("nacionalidad-page").classList.remove("hidden");
        document.getElementById("titulo").classList.remove("hidden");
        document.getElementById("formulario").classList.add("hidden");
        document.getElementById("manual").classList.add("hidden");
        document.getElementById("Doc_Necesaria_Comunitario").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.add("hidden");
        document.getElementById("manual").classList.add("hidden");  
        document.getElementById("mensaje-aclaratorio").classList.add("hidden");
      }

      <script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxigLGGauWCphFL95VD5R0mWm5mM65_wuq5KhwWxyZmM8I8h5pJQ-nKzJ5u6DqpNJTvaw/exec";

  // üîé Nueva funci√≥n buscar()
  async function buscar() {
    const searchText = document.getElementById("search-box").value.trim();
    const opcionesMarcadas = []; // si usas checkboxes en sugerencias, aqu√≠ se pasan

    if (!searchText) {
      mostrarModal("Por favor, introduce un texto para buscar.");
      return;
    }

    document.getElementById("loader").style.display = "block";
    document.getElementById("resultado").classList.add("hidden");

    try {
      const response = await fetch(WEBAPP_URL, {
        method: "POST",
        body: JSON.stringify({ searchText, opcionesMarcadas })
      });

      if (!response.ok) throw new Error("Error en la petici√≥n");

      const data = await response.json();
      mostrarResultado(data);

    } catch (err) {
      console.error(err);
      mostrarModal("Error al conectar con el servidor.");
    } finally {
      document.getElementById("loader").style.display = "none";
      document.getElementById("resultado").classList.remove("hidden");
    }
  }

  // Reemplazamos onclick del bot√≥n Buscar
  document.getElementById("buscarBtn").onclick = () => {
    ocultar_resultado();
    buscar();
  };

  // Modificamos buscarDesdeSugerencias()
  function buscarDesdeSugerencias() {
    const checkboxes = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]:checked');
    const seleccionados = Array.from(checkboxes).map(cb => cb.value);

    if (seleccionados.length === 0) {
      alert("Debes seleccionar al menos un concepto.");
      return;
    }

    let conceptoBusqueda = null;

    if (seleccionados.length === 1) {
      conceptoBusqueda = seleccionados[0];
    } else {
      for (const combinacion of combinacionesValidas) {
        const esSubconjunto = seleccionados.every(sel => combinacion.includes(sel));
        if (esSubconjunto) {
          conceptoBusqueda = combinacion[0];
          break;
        }
      }
      if (!conceptoBusqueda) {
        alert("La combinaci√≥n seleccionada no es v√°lida.");
        return;
      }
    }

    document.getElementById("search-box").value = conceptoBusqueda;
    buscar();
    ocultarSugerencias();
  }



    </script>
  </body>
</html>

<!--      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxigLGGauWCphFL95VD5R0mWm5mM65_wuq5KhwWxyZmM8I8h5pJQ-nKzJ5u6DqpNJTvaw/exec"; -->
