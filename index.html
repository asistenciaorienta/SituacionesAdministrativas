<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>Formulario Unificado</title>
    <style>

      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 40px;
        background: #f5f5f5;
      }

      #nacionalidad-page {
        max-width: 870px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        padding: 30px 20px 40px;
        margin: auto  auto 40px;
      }

      #Doc_Necesaria_Comunitario {
        max-width: 870px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        padding: 30px 20px 40px;
        margin: auto  auto 40px;
      }

      h1 {
        color: #007A33;
        margin-bottom: 24px;
      }

      h2 {
        color: #007A33;
        margin-bottom: 24px;
      }

      h3 {
        color: #007A33;
        margin-bottom: 24px;
      }
      .btn {
        background-color: #007A33;
        color: white;
        border: none;
        padding: 14px 32px;
        margin: 12px 14px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,122,51,0.4);
      }

      .btn:hover {
        background-color: #005e29;
        box-shadow: 0 4px 8px rgba(0,94,41,0.6);
      }

      img {
        max-width: 90%;
        max-height: 70vh;
        object-fit: contain;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      /* Estilos del formulario */
      .card {
        width: 870px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        overflow: hidden;
        padding: 12px 16px;
        margin: auto;
        text-align: left;
      }

      .search-container {
        display: flex;
        align-items: center;
        border-radius: 12px;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 0 0 2px #007A33;
        margin-bottom: 0px;
      }

      #search-box {
        width: 100%;
        padding: 10px;
        border: 0px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
        resize: none;
        box-sizing: border-box;
      }

      .button-container {
        text-align: center;
        padding: 12px 0;
        border-top: 1px solid #ddd;
        margin-top: 10px;
      }

      #buscarBtn {
        background-color: #007A33;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
      }

      .btn-small {
        background-color: #ccc;
        color: #333;
        border: none;
        padding: 6px 16px;
        font-size: 14px;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: none;
        margin-top: 12px;
        transition: background-color 0.3s ease;
      }

      .btn-small:hover {
        background-color: #bbb;
      }

      .nacionalidad-card {
        text-align: center;
        padding: 2rem;
      }

      .botones-nacionalidad {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 1rem;
        flex-wrap: wrap;
      }

      .btn-wrapper {
        position: relative;
        display: inline-block;
      }

      .tooltip-container {
        position: absolute;
        top: 15px;
        left: 18px;
      }

      .help-icon {
        background-color: #FFFFFF;
        color: #007A33;
        border-radius: 30%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        line-height: 20px;
        cursor: pointer;
        z-index: 2;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      }

      .tooltip-text {
        visibility: hidden;
        width: 140px;
        background-color: white;
        color: #333;
        text-align: left;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        top: 25px;
        left: 0;
        z-index: 5;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      .tooltip-container:hover .tooltip-text {
        visibility: visible;
      }

      .document-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 300px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        padding: 30px 20px 40px;
        margin: auto  auto 40px;
      }

      .document-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        color: #000;
        cursor: pointer;
      }

      .document-item input[type="radio"] {
        appearance: none;
        border: 2px solid #007A33;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        position: relative;
        margin: 0;
      }

      .document-item input[type="radio"]:checked::before {
        content: "";
        position: absolute;
        background: #007A33;
        border-radius: 50%;
        width: 10px;
        height: 10px;
        top: 3px;
        left: 3px;
      }

      .sub-options {
        margin-left: 48px;
        margin-top: -5px;
        margin-bottom: 10px;
        display: none;
        flex-direction: column;
        gap: 8px;
      }

      .sub-options label {
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .sub-options input[type="radio"] {
        appearance: none;
        border: 2px solid #007A33;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        position: relative;
        margin: 0;
      }

      .sub-options input[type="radio"]:checked::before {
        content: "";
        position: absolute;
        background: #007A33;
        border-radius: 50%;
        width: 8px;
        height: 8px;
        top: 3px;
        left: 3px;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex; /* Para centrar el contenido */
        justify-content: center; /* Centrado horizontal */
        align-items: center; /* Centrado vertical */
        z-index: 1000;
      }

      .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 80%;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      #resultado table {
        width: 100%;
        font-family: Arial, sans-serif;
        font-size: 14px;
        margin-top: 1rem;
        border: 1px solid #ccc;  
        border-collapse: collapse;        
      }

      #resultado td {
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
        border-bottom: 1px solid #eee;
        background-color: #ffffff;
      }
      #resultado th {
        padding: 8px 10px;
        text-align: left;
        vertical-align: top;
        border-bottom: 1px solid #eee;
        background-color: #f5f5f5;
      }

      #resultado.hidden {
        display: none;
      }

      .resultado-centrado {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      .hidden {
        display: none;
      }

      .panel-sugerencias {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.6s ease;
        background-color: #f5f5f5;
      }

      .panel-sugerencias.visible {
        max-height: 700px; /* suficiente para mostrar todo */
      }

      .sugerencias-grid {
        display: flex;
        gap: 0px;
        max-width: 900px;
        margin: 0 auto 30px;
      }

      .sugerencias-grid label input[type="checkbox"]:disabled + span,
      .sugerencias-grid label input[type="checkbox"]:disabled {
        filter: grayscale(100%);
        cursor: not-allowed;
      }

      .sugerencias-grid label.disabled {
        color: #999999;
        cursor: not-allowed;
      }

      .columna-izq {
        flex: 1.5;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .columna-der {
        flex: 1.2;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .footer-logo {
        position: fixed;
        bottom: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 15px;
      }

      .footer-logo .logo-text {
        font-size: 14px;
        font-weight: bold;
        color: #007A33;
        left: 0;
      }

      .footer-logo img {
        height: 70px;
      }

      .footer-datos {
        position: fixed;
        bottom: 0;
        right: 0;
        background-color: #f5f5f5;
        color: #007A33;
        font-size: 14px;
        text-align: right;
        padding: 10px 15px;
        border-top-left-radius: 8px;
        box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
      }
#inicio {
  position: fixed;
  top: 0px;
  right: 10px;
  z-index: 1000; /* Asegura que esté por encima de otros elementos */
}
#ayuda {
  position: fixed;
  top: 50px;
  right: 10px;
  z-index: 1000; /* Asegura que esté por encima de otros elementos */
}
    </style>
  </head>
  <body>
    <!-- Diseño e idea original de la Dirección Provincial de Granada, en concreto de:
    Jefe de Servicio: Francisco Escabias García.
    Diseñador: Valentín Jiménez Extremera.
    Contenido: Elisabeth Huertas García y José Manuel Robles Chaves.
    Testeo y verificación: Isabel Peláez Carmona, Silvia Gómez Martín, Inmaculada Ortega Avilés, Beatriz Girela Muñoz.
    Aporte de información: Todas las oficinas SAE de la provincia de Granada y sus direcciones de ATE. -->

    <div id="titulo" class="nacionalidad-card">
      <h1>Ayuda para el registro en SILA de una persona migrante</h2>
    </div>
    <div id="inicio" class="nacionalidad-card">
      <button class="btn-small" onclick="volverInicio(); confirmarBorrado();">Inicio</button>
    </div>
      <div id="ayuda" class="nacionalidad-card">
      <button class="btn-small" onclick="ayuda();">Ayuda</button>
    </div>  
          
    <!-- Página de nacionalidad (ORIGEN) -->
    <div id="nacionalidad-page" class="nacionalidad-card">


      <h2>Selecciona el Origen de la persona usuaria</h2>

      <div class="botones-nacionalidad">
        <div class="btn-wrapper">
          <button class="btn" onclick="mostrarFormularioComunitario()">Comunitario/a</button>
          <span class="tooltip-container">
            <span class="help-icon">?</span>
            <div class="tooltip-text">
              <strong>Países comunitarios:</strong><br>
                Austria, Bélgica, Bulgaria, Chipre, República Checa, Dinamarca, Estonia, Finlandia, Francia,
                Alemania, Grecia, Hungría, Irlanda, Italia, Letonia, Lituania, Luxemburgo, Malta,
                Países Bajos, Polonia, Portugal, Rumanía, Eslovaquia, Eslovenia, España, Suecia,
                Islandia, Liechtenstein, Noruega, Suiza.
            </div>
          </span>
        </div>
        <button class="btn" onclick="mostrarFormularioNoComunitario()">No Comunitario/a</button>
      </div>
      
    </div>
  
    <!-- Documentación Necesaria para Comunitario -->
    <div id="Doc_Necesaria_Comunitario" class="hidden">
      <h2>Documentación Necesaria para Inscribir a una persona Comunitaria</h2>
      <br>
      Documento acreditativo de identidad
      <br>
      Certificado de inscripción .....
      <br>
      Tarjeta Verde...
      <br>
      <br>
      <button class="btn-small" onclick="volverNacionalidad()">← Volver</button>
    </div>

    <!-- Formulario No Comunitario -->
    <div id="formulario_No_Comunitario" class="hidden">
      <h2>¿Que documentación aporta la persona No Comunitaria?</h2>
      <div class="document-list">
        <label class="document-item">
          <input type="radio" name="documento" value="TIE" onclick="gestionarSeleccion(this)">
          TIE
        </label>
        <div id="subopciones-TIE" class="sub-options">
          <label><input type="radio" name="estado-TIE" value="En Vigor"> En Vigor</label>
          <label><input type="radio" name="estado-TIE" value="Caducad"> Caducada</label>
        </div>

        <label class="document-item">
          <input type="radio" name="documento" value="Resolución" onclick="gestionarSeleccion(this)">
          Resolución
        </label>
        <div id="subopciones-Resolución" class="sub-options">
          <label><input type="radio" name="estado-Resolución" value="En Vigor"> En Vigor</label>
          <label><input type="radio" name="estado-Resolución" value="Caducado"> Caducada</label>
        </div>

        <label class="document-item">
          <input type="radio" name="documento" value="Tarjeta Roja" onclick="gestionarSeleccion(this)">
          Tarjeta Roja
        </label>
        <div id="subopciones-Tarjeta Roja" class="sub-options">
          <label><input type="radio" name="estado-Tarjeta" value="En Vigor"> En Vigor</label>
          <label><input type="radio" name="estado-Tarjeta" value="Caducado"> Caducada</label>
        </div>

        <label class="document-item">
          <input type="radio" name="documento" value="NIE" onclick="gestionarSeleccion(this)">
          NIE
        </label>
        <div id="subopciones-NIE" class="sub-options">
          <label><input type="radio" name="estado-NIE" value="Aporta Solicitud"> Aporta Solicitud</label>
          <label><input type="radio" name="estado-NIE" value="No aporta"> No aporta Solicitud</label>
        </div>
      </div>
      <button class="btn" onclick="evaluarDocumento()">Continuar</button>   <br>   
      <button class="btn-small" onclick="volverNacionalidad()">← Volver</button>
    </div>

    <!-- Imagen del manual -->
    <div id="manual" class="hidden">
      <h2>Consulta el manual</h2>
      <img id="manualImg" src="" alt="Manual">
      <br>
      <button class="btn" onclick="mostrarFormulario()">Continuar</button> <br>
      <button class="btn-small" onclick="volverNoComunitario()">← Volver</button>
    </div>

    <!-- Mensaje aclaratorio -->
    <div id="mensaje-aclaratorio" class="hidden">
      <h2>Aclaración</h2>
      <p id="contenido-aclaratorio">Aquí aparecerá el contenido según la selección.</p>
      <button class="btn-small" onclick="volverNoComunitario()">← Volver</button>
    </div>

    <!-- Formulario completo -->
    <div id="formulario" class="hidden">
      <div class="card">
        <!-- Campo de búsqueda -->
        <div class="search-container">
          <textarea id="search-box" placeholder="Copia aquí los conceptos clave..." rows="4" onfocus="preguntarBorrado(event)"></textarea> 
        </div>

        <!-- Botón de buscar -->
        <div class="button-container">
          <button id="buscarBtn" onclick="ocultar_resultado();">Buscar</button>
        </div>
        <div id="loader" style="display:none; text-align:center; margin:10px;">
          <span>🔄 Buscando... por favor, espera</span>
        </div>

        <div id="resultado" class="hidden"></div>

        <div id="sugerenciasPanel" class="panel-sugerencias hidden">
          <h3 style="text-align:center;">Selecciona uno o más conceptos clave:</h3>
          <form id="sugerenciasForm" class="sugerencias-grid"></form>
          <div style="text-align: center;">
            <button class="btn" onclick="buscarDesdeSugerencias()">Buscar con selección</button>
            <button class="btn-small" onclick="ocultarSugerencias()">← Ocultar</button>
          </div>
        </div>

        <!-- Botón de volver -->
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn-small" onclick="volverInicioDesdeFormulario(); confirmarBorrado();">← Volver</button>
        </div>
      </div>
    </div>

    <!-- Modal personalizado ALERTA-->
    <div id="mi-modal" class="hidden modal">
      <div class="modal-content">
        <p id="modal-texto"></p>
        <button class="btn" onclick="cerrarModal()">Cerrar</button>
      </div>
    </div>

    <!-- Modal para confirmar borrado -->
    <div id="modal-borrar" class="hidden modal">
      <div class="modal-content">
        <p>¿Deseas borrar el contenido actual?</p>
        <div style="text-align: center; margin-top: 20px;">
          <button class="btn" onclick="confirmarBorrado()">Sí, borrar</button>
          <button class="btn-small" onclick="cerrarModalBorrar()">No, modificar</button>
        </div>
      </div>
    </div>

    <!-- Pie de página fijo -->
    <footer>
      <div class="footer-logo">
        <div class="logo-text">Dirección Provincial de Granada</div>
        <img src="https://i.imgur.com/sX386es.png" alt="Logo Junta de Andalucía" />
      </div>
      <div class="footer-datos">
        <b>Apoyo durante la fase de testeo para la resolución de dudas y la recogida de incidencias:</b><br>
        <hr>
        Elisabeth Huertas García &lt;<a href="mailto:elisabeth.huertas.garcia@juntadeandalucia.es">elisabeth.huertas.garcia@juntadeandalucia.es</a>&gt; – 765145<br>
        José Manuel Robles Chaves &lt;<a href="mailto:josem.robles@juntadeandalucia.es">josem.robles@juntadeandalucia.es</a>&gt; – 653467
      </div>
    </footer>
    
    <script>
      function ayuda() {
        window.open("https://www.tupagina.com", "_blank");
      }
      
      function actualizarDisponibles() {
        const checkboxes = Array.from(document.querySelectorAll('#sugerenciasForm input[type="checkbox"]'));
        const labels = Array.from(document.querySelectorAll('#sugerenciasForm label'));

        // Seleccionados actualmente (checkbox checked)
        const seleccionados = checkboxes.filter(cb => cb.checked).map(cb => cb.value);

        // Si no hay seleccionados, activar todo y quitar clase disabled
        if (seleccionados.length === 0) {
          checkboxes.forEach(cb => {
            cb.disabled = false;
          });
          labels.forEach(label => {
            label.classList.remove('disabled');
          });
          return;
        }

        // Función para comprobar si una combinación válida contiene TODOS los seleccionados + candidato
        // Queremos que al marcar otro, la combinación sea una superconjunto de los seleccionados actuales + ese candidato
        function esCompatible(candidato) {
          // Por cada combinación válida
          return combinacionesValidas.some(comb => {
            // La combinación debe contener al candidato
            if (!comb.includes(candidato)) return false;

            // Y debe contener todos los seleccionados
            return seleccionados.every(sel => comb.includes(sel));
          });
        }

        // Recorremos todos checkboxes y deshabilitamos si no es compatible
        checkboxes.forEach(cb => {
          if (seleccionados.includes(cb.value)) {
            // Checkbox seleccionado: siempre habilitado
            cb.disabled = false;
            cb.parentElement.classList.remove('disabled');
          } else {
            // No seleccionado: habilitar solo si es compatible con la selección
            if (esCompatible(cb.value)) {
              cb.disabled = false;
              cb.parentElement.classList.remove('disabled');
            } else {
              cb.disabled = true;
              cb.parentElement.classList.add('disabled');
            }
          }
        });
      }

      // Añadir evento a cada checkbox para actualizar al cambiar
      function anadirEventosCheck() {
        const checkboxes = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.addEventListener('change', actualizarDisponibles);
        });
      }

      // En tu función mostrarSugerencias, tras crear el formulario, llama a añadirEventosCheck()


      function ocultar_resultado(){
        document.getElementById('resultado').classList.add('hidden');
      }
      
      function preguntarBorrado() {
        const textarea = document.getElementById('search-box');

        // Si el modal ya está abierto, no hacer nada
        const modalVisible = !document.getElementById('modal-borrar').classList.contains('hidden');
        if (modalVisible) return;

        // Si hay texto, mostrar el modal
        if (textarea.value.trim() !== '') {
          textarea.blur(); // Para evitar escribir mientras responde
          document.getElementById('modal-borrar').classList.remove('hidden');
        }
      }
      function confirmarBorrado() {
        const textarea = document.getElementById('search-box');
        textarea.value = '';
        cerrarModalBorrar();
      }

      function cerrarModalBorrar() {
        document.getElementById('search-box').focus();
        document.getElementById('modal-borrar').classList.add('hidden');
        document.getElementById('resultado').classList.add('hidden');
      }

      const urls = {
        "TIE": "https://i.imgur.com/6YW6bTX.png",
        "Documento": "https://i.imgur.com/mws3JN2.png",
        "Tarjeta Roja": "https://i.imgur.com/qjRKecb.png"
      };

      const conceptosClave = [
        "Art 50 TUE. Retirada Reino Unido",
        "Asilo / Apátrida / Desplazados o protección internacional",
        "Circunstancias excepcionales",
        "Estudio, prácticas o voluntariado",
        "Familiar de ciudadano de UE",
        "Ley 14/2013",
        "Menores",
        "Reagrupación familiar",
        "Residencia temporal que Autoriza a trabajar",
        "Residencia temporal que No Autoriza a trabajar",
        "Residencia Larga Duración",
        "Permiso de Residencia y Trabajo",
        "Visado búsqueda empleo",
        "Prestación sin autorización laboral"
      ];

      const combinacionesValidas = [
        ["Asilo / Apátrida / Desplazados o protección internacional", "Residencia temporal que Autoriza a trabajar"],
        ["Asilo / Apátrida / Desplazados o protección internacional", "Residencia temporal que No Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que Autoriza a trabajar"],
        ["Permiso de Residencia y Trabajo", "Residencia temporal que No Autoriza a trabajar"],        
        ["Residencia Larga Duración", "Permiso de Residencia y Trabajo"],
        ["Asilo / Apátrida / Desplazados o protección internacional", "Residencia Larga Duración", "Permiso de Residencia y Trabajo"]
      ];

      function gestionarSeleccion(seleccionado) {
        const opciones = ["TIE", "Resolución", "Tarjeta Roja", "NIE"];
        
        // Ocultar todas las subopciones y limpiar selecciones previas
        opciones.forEach(opcion => {
          const subDiv = document.getElementById(`subopciones-${opcion}`);
          if (subDiv) {
            subDiv.style.display = "none";
            const radios = subDiv.querySelectorAll('input[type="radio"]');
            radios.forEach(r => r.checked = false);
          }
        });

        // Mostrar solo las subopciones correspondientes
        const seleccion = seleccionado.value;
        const sub = document.getElementById(`subopciones-${seleccion}`);
        if (sub) sub.style.display = "flex";
      }

      function evaluarDocumento() {
        const seleccionPrincipal = document.querySelector('input[name="documento"]:checked');
        if (!seleccionPrincipal) {
          mostrarModal("Selecciona una opción.");
          return;
        }

        const valorPrincipal = seleccionPrincipal.value;
        let subValor = null;

        // Detectar subvalor según el documento principal
        if (valorPrincipal === "TIE") {
          subValor = document.querySelector('input[name="estado-TIE"]:checked')?.value;
        } else if (valorPrincipal === "Resolución") {
          subValor = document.querySelector('input[name="estado-Resolución"]:checked')?.value;
        } else if (valorPrincipal === "Tarjeta Roja") {
          subValor = document.querySelector('input[name="estado-Tarjeta"]:checked')?.value;
        } else if (valorPrincipal === "NIE") {
          subValor = document.querySelector('input[name="estado-NIE"]:checked')?.value;
        }

        if (!subValor) {
          mostrarModal("Selecciona una sub-opción.");
          return;
        }

        // Mostrar manual si está en vigor
        if (valorPrincipal === "TIE" && subValor === "En Vigor") {
          mostrarManual("TIE");
        } else if (valorPrincipal === "Resolución" && subValor === "En Vigor") {
          mostrarManual("Documento");
        } else if (valorPrincipal === "Tarjeta Roja" && subValor === "En Vigor") {
          mostrarManual("Tarjeta Roja");
        } else {
          // Mostrar aclaración
          document.getElementById("formulario_No_Comunitario").classList.add("hidden");
          document.getElementById("mensaje-aclaratorio").classList.remove("hidden");
          document.getElementById("contenido-aclaratorio").textContent = `Has seleccionado: ${valorPrincipal} - ${subValor}. Aquí aparecerá la aclaración correspondiente.`;
        }
      }

      function mostrarModal(mensaje) {
        document.getElementById("modal-texto").textContent = mensaje;
        document.getElementById("mi-modal").classList.remove("hidden");
      }

      function cerrarModal() {
        document.getElementById("mi-modal").classList.add("hidden");
      }

      function mostrarFormularioComunitario() {
        document.getElementById("nacionalidad-page").classList.add("hidden");
        document.getElementById("Doc_Necesaria_Comunitario").classList.remove("hidden");
        document.getElementById("titulo").classList.add("hidden");
      }      

      function mostrarFormularioNoComunitario() {
        document.getElementById("nacionalidad-page").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.remove("hidden");
        document.getElementById("titulo").classList.add("hidden");
      }

      function mostrarManual(tipo) {
        localStorage.setItem("tipoDocumento", tipo);        
        document.getElementById("formulario_No_Comunitario").classList.add("hidden"); 
        document.getElementById("manualImg").src = urls[tipo];
        document.getElementById("manual").classList.remove("hidden");       
      }

      function mostrarFormulario() {
        document.getElementById("manual").classList.add("hidden");
        document.getElementById("formulario").classList.remove("hidden");
      }

      function volverNacionalidad() {
        document.getElementById("Doc_Necesaria_Comunitario").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.add("hidden");
        document.getElementById("nacionalidad-page").classList.remove("hidden");
        document.getElementById("titulo").classList.remove("hidden");
      }
      
      function volverNoComunitario() {
        document.getElementById("manual").classList.add("hidden");  
        document.getElementById("mensaje-aclaratorio").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.remove("hidden");
      }

      function mostrarResultado(data) {
          const contenedor = document.getElementById("resultado");
          contenedor.innerHTML = ""; // Limpiar resultados anteriores

          if (!data || data.length === 0) {
            const ayuda = document.createElement("p");
            ayuda.innerHTML = `
              <p style="text-align: center;">No se encontró nada. Si necesitas ayuda, puedes clicar en: 
              <button class="btn-small" onclick="mostrarSugerencias()">Mostrar sugerencias</button></p>
            `;
            contenedor.appendChild(ayuda);
            return;
          }

          data.forEach(item => {
            const card = document.createElement("div");
            card.className = "resultado-item";
            card.innerHTML = `
              <p><strong>Código:</strong> ${item.codigo}</p>
              <p><strong>Autorización:</strong> ${item.autoriza}</p>
              <p><strong>Modalidad:</strong> ${item.modalidad}</p>
              <p><strong>Observaciones:</strong> ${item.observaciones}</p>
              <p><strong>Documentación:</strong> ${item.documento}</p>
              <hr>
            `;
            contenedor.appendChild(card);
          });
      }

      function mostrarSugerencias() {
        const panel = document.getElementById("sugerenciasPanel");
        const form = document.getElementById("sugerenciasForm");

        // Mostrar el panel con animación (quita clase hidden y añade visible con delay)
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("visible"), 100);

        // Dividir conceptos en dos columnas de 7 elementos
        const primeraColumna = conceptosClave.slice(0, 7);
        const segundaColumna = conceptosClave.slice(7, 14);

        // Crear contenido HTML para ambas columnas dentro del formulario
        const col1HTML = primeraColumna.map(c =>
          `<label><input type="checkbox" name="concepto" value="${c}"> ${c}</label>`
        ).join("");

        const col2HTML = segundaColumna.map(c =>
          `<label><input type="checkbox" name="concepto" value="${c}"> ${c}</label>`
        ).join("");

        // Insertar el contenido en el formulario (sugerenciasForm)
        form.innerHTML = `
          <div class="columna-izq">${col1HTML}</div>
          <div class="columna-der">${col2HTML}</div>
        `;
        anadirEventosCheck();
        actualizarDisponibles();  
      }

      function ocultarSugerencias() {
        const panel = document.getElementById("sugerenciasPanel");
        panel.classList.remove("visible");
        setTimeout(() => panel.classList.add("hidden"), 600);
      }

      function mostrarAyudaConceptos() {
        const container = document.getElementById("resultado");
        const lista = conceptosClave.map(c => `<li>${c}</li>`).join("");
        container.innerHTML = `
          <h3 style="color: #007A33;">Conceptos que puedes utilizar:</h3>
          <ul style="text-align: left; max-width: 700px; margin: 20px auto; font-size: 16px; line-height: 1.6;">
            ${lista}
          </ul>
          <div style="text-align: center; margin-top: 20px;">
            <button class="btn-small" onclick="document.getElementById('resultado').classList.add('hidden');">← Ocultar ayuda</button>
          </div>`;
      }

      function volverInicioDesdeFormulario() {
        document.getElementById("search-box").value = "";

        document.getElementById("formulario").classList.add("hidden");
        document.getElementById("manual").classList.remove("hidden");
        document.getElementById("buscarBtn").classList.remove("hidden");
      }

      function volverInicio() {
        document.getElementById("nacionalidad-page").classList.remove("hidden");
        document.getElementById("titulo").classList.remove("hidden");
        document.getElementById("formulario").classList.add("hidden");
        document.getElementById("manual").classList.add("hidden");
        document.getElementById("Doc_Necesaria_Comunitario").classList.add("hidden");
        document.getElementById("formulario_No_Comunitario").classList.add("hidden");
        document.getElementById("manual").classList.add("hidden");  
        document.getElementById("mensaje-aclaratorio").classList.add("hidden");
      }

      <script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxigLGGauWCphFL95VD5R0mWm5mM65_wuq5KhwWxyZmM8I8h5pJQ-nKzJ5u6DqpNJTvaw/exec";

  // 🔎 Nueva función buscar()
  async function buscar() {
    const searchText = document.getElementById("search-box").value.trim();
    const opcionesMarcadas = []; // si usas checkboxes en sugerencias, aquí se pasan

    if (!searchText) {
      mostrarModal("Por favor, introduce un texto para buscar.");
      return;
    }

    document.getElementById("loader").style.display = "block";
    document.getElementById("resultado").classList.add("hidden");

    try {
      const response = await fetch(WEBAPP_URL, {
        method: "POST",
        body: JSON.stringify({ searchText, opcionesMarcadas })
      });

      if (!response.ok) throw new Error("Error en la petición");

      const data = await response.json();
      mostrarResultado(data);

    } catch (err) {
      console.error(err);
      mostrarModal("Error al conectar con el servidor.");
    } finally {
      document.getElementById("loader").style.display = "none";
      document.getElementById("resultado").classList.remove("hidden");
    }
  }

  // Reemplazamos onclick del botón Buscar
  document.getElementById("buscarBtn").onclick = () => {
    ocultar_resultado();
    buscar();
  };

  // Modificamos buscarDesdeSugerencias()
  function buscarDesdeSugerencias() {
    const checkboxes = document.querySelectorAll('#sugerenciasForm input[type="checkbox"]:checked');
    const seleccionados = Array.from(checkboxes).map(cb => cb.value);

    if (seleccionados.length === 0) {
      alert("Debes seleccionar al menos un concepto.");
      return;
    }

    let conceptoBusqueda = null;

    if (seleccionados.length === 1) {
      conceptoBusqueda = seleccionados[0];
    } else {
      for (const combinacion of combinacionesValidas) {
        const esSubconjunto = seleccionados.every(sel => combinacion.includes(sel));
        if (esSubconjunto) {
          conceptoBusqueda = combinacion[0];
          break;
        }
      }
      if (!conceptoBusqueda) {
        alert("La combinación seleccionada no es válida.");
        return;
      }
    }

    document.getElementById("search-box").value = conceptoBusqueda;
    buscar();
    ocultarSugerencias();
  }



    </script>
  </body>
</html>

<!--      const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxigLGGauWCphFL95VD5R0mWm5mM65_wuq5KhwWxyZmM8I8h5pJQ-nKzJ5u6DqpNJTvaw/exec"; -->
